<script>
  document.addEventListener("DOMContentLoaded", function () {
    window.addEventListener("load", resizeBody);
    window.addEventListener("resize", resizeBody);
    const form = document.getElementById("form");
    if (form !== null) {
      form.addEventListener("submit", onSubmit);
    }
  })

  function serializeFormToJson(form) {
    const formData = new FormData(form);
    const jsonData = {};

    formData.forEach((value, key) => {
      jsonData[key] = value.toString();
    });
    return jsonData;
  }

  function resizeBody() {
    var scale = window.innerWidth / window.screen.width;
    document.body.style.width = 100 / scale + "%";
    document.body.style.height = 100 / scale + "%";
    document.body.style.transform = "scale(" + scale + ")";
  };

  function onSubmit(e) {
    e.preventDefault(); //デフォルトの動作をキャンセル

    const form = document.getElementById("form");
    const resultDiv = document.getElementById("result");
    const loadingSpinner = document.getElementById("loadingSpinner");
    loadingSpinner.style.display = "block";

    const postString = JSON.stringify(serializeFormToJson(form));
    // console.log(postString);

    google.script.run
      .withSuccessHandler(onSuccess)
      .withFailureHandler(onFailure)
      .postToServer(e.target.name, postString);
    function onSuccess(data) {
      // console.log("onSuccess");
      // console.log(data);
      form.style.display = "none";
      resultDiv.innerHTML = data;
      loadingSpinner.style.display = "none";
    }
    function onFailure(error) {
      // console.log("onFailure");
      // console.log(error);
      form.style.display = "none";
      resultDiv.innerHTML = "エラーが発生しました: " + error;
      loadingSpinner.style.display = "none";
    }
  }

  function getRecords(sheetName) {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(data => onSuccess(data, resolve, reject))
        .withFailureHandler(error => onFailure(error, reject))
        .getRecords(currentRecord, sheetName);
    });
    function onSuccess(data, resolve, reject) {
      // console.log("onSuccess");
      // console.log(data);
      resolve(JSON.parse(data));
    }
    function onFailure(error, reject) {
      // console.log("onFailure");
      // console.log(error);
      reject(new Error("データ取得エラー"));
    }
  }
</script>