<script>
  function serializeFormToJson(form) {
    const formData = new FormData(form);
    const jsonData = {};

    formData.forEach((value, key) => {
      jsonData[key] = value.toString();
    });
    return jsonData;
  }

  function resizeBody() {
    var scale = window.innerWidth / window.screen.width;
    document.body.style.width = 100 / scale + "%";
    document.body.style.height = 100 / scale + "%";
    document.body.style.transform = "scale(" + scale + ")";
  };

  document.addEventListener("DOMContentLoaded", function () {
    window.addEventListener("load", resizeBody);
    window.addEventListener("resize", resizeBody);

    // 今日の日付を日付フィールドに設定
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("date").value = today;

    // 単価と給油量のロストフォーカス時
    const pricePerLiterInput = document.getElementById("pricePerLiter");
    const fuelAmountInput = document.getElementById("fuelAmount");
    pricePerLiterInput.addEventListener("blur", calculateTotalPrice);
    fuelAmountInput.addEventListener("blur", calculateTotalPrice);
    function calculateTotalPrice() {
      const pricePerLiter = parseFloat(pricePerLiterInput.value);
      const fuelAmount = parseFloat(fuelAmountInput.value);
      if (!isNaN(pricePerLiter) && !isNaN(fuelAmount)) {
        const totalPrice = Math.round(pricePerLiter * fuelAmount);
        document.getElementById("totalPrice").value = totalPrice.toString();
      }
    }

    // 総走行距離のロストフォーカス時
    const distanceInput = document.getElementById("distance");
    const lastDistanceInput = document.getElementById("lastDistance");
    distanceInput.addEventListener("blur", calculateThisDistance);
    function calculateThisDistance() {
      const lastDistance = parseFloat(lastDistanceInput.value);
      const distance = parseFloat(distanceInput.value);

      if (!isNaN(distance) && !isNaN(lastDistance)) {
        const thisDistance = Math.round(distance - lastDistance);
        document.getElementById("thisDistance").value = thisDistance.toString();
      }
    }

    // 送信ボタンがクリックされた時
    const fuelForm = document.getElementById("fuelForm");
    fuelForm.addEventListener("submit", onSubmit);
    function onSubmit(e) {
      e.preventDefault();

      const resultDiv = document.getElementById("result");
      const loadingSpinner = document.getElementById("loadingSpinner");
      loadingSpinner.style.display = "block";

      const postString = JSON.stringify(serializeFormToJson(fuelForm));
      // console.log(postString);

      google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(onFailure)
        .postToServer(postString);
      function onSuccess(data) {
        // 燃費データを受信して表示
        resultDiv.innerHTML = data;
        loadingSpinner.style.display = "none";
      }
      function onFailure(error) {
        resultDiv.innerHTML = "エラーが発生しました: " + error;
        loadingSpinner.style.display = "none";
      }
    }
  });
</script>